apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: default
data:
  kong.yml: |
    _format_version: "2.1"
    services:
    - name: auth-v1
      url: http://supabase-auth:9999
      routes:
      - name: auth-v1-route
        paths:
        - /auth/v1
        strip_path: true
    - name: rest-v1
      url: http://supabase-rest:3000
      routes:
      - name: rest-v1-route
        paths:
        - /rest/v1
        strip_path: true
    - name: realtime-v1
      url: http://supabase-realtime:4000
      routes:
      - name: realtime-v1-route
        paths:
        - /realtime/v1
        strip_path: true
    - name: storage-v1
      url: http://supabase-storage:5000
      routes:
      - name: storage-v1-route
        paths:
        - /storage/v1
        strip_path: true
    - name: meta-v1
      url: http://supabase-meta:8080
      routes:
      - name: meta-v1-route
        paths:
        - /meta/v1
        strip_path: true
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: supabase-kong
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: supabase-kong
  template:
    metadata:
      labels:
        app: supabase-kong
    spec:
      containers:
        - name: kong
          image: kong:2.8.1
          ports:
            - containerPort: 8000
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/var/lib/kong/kong.yml"
            - name: KONG_PLUGINS
              value: "request-transformer,cors,key-auth,acl"
            - name: KONG_DNS_ORDER
              value: "LAST,A,CNAME"
          volumeMounts:
            - name: kong-config
              mountPath: /var/lib/kong/kong.yml
              subPath: kong.yml
      volumes:
        - name: kong-config
          configMap:
            name: kong-config
---
apiVersion: v1
kind: Service
metadata:
  name: supabase-kong
  namespace: default
spec:
  selector:
    app: supabase-kong
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
